<script>
    const STORAGE_KEY = 'dadsBankOlivia_v1';

    let checkingBalance = 110.79;
    let btcAmount = 0.00357743;
    let btcPrice = 0;

    const btcMetaText = document.getElementById('btcMetaText');

    let transactions = [
        {date: '1/13', desc: 'Robux', amount: -2.00, balance: 110.79},
        {date: '1/12', desc: 'Robux', amount: -1.00, balance: 112.79},
        {date: '1/12', desc: 'Claw machine', amount: -20.00, balance: 113.79},
        {date: '1/5', desc: 'Nails', amount: -9.77, balance: 133.79},
        {date: '1/5', desc: '5 below', amount: -5.44, balance: 143.56},
        {date: '1/1', desc: 'Sweater', amount: -10.88, balance: 149.00},
        {date: '12/27', desc: 'Claw machine', amount: -37.99, balance: 159.88},
        {date: '12/26', desc: 'Boba', amount: -7.99, balance: 197.87},
        {date: '12/25', desc: "G'ma Carla Christmas", amount: 100.00, balance: 205.86},
        {date: '12/25', desc: 'Christmas', amount: 60.00, balance: 105.86},
        {date: '11/13', desc: 'Birthday', amount: 45.00, balance: 45.86},
        {date: '10/26', desc: 'Buy bitcoin', amount: -90.00, balance: 0.86},
        {date: '10/22', desc: 'Yarn and fiber', amount: -24.94, balance: 90.86},
        {date: '10/19', desc: 'Grades', amount: 50.00, balance: 115.80},
        {date: '10/16', desc: 'Babysitting', amount: 20.00, balance: 65.80},
        {date: '10/8', desc: 'Goodwill', amount: -43.94, balance: 45.80},
        {date: '10/2', desc: 'Babysitting', amount: 20.00, balance: 89.74},
        {date: '9/25', desc: 'Roller skates', amount: -49.99, balance: 69.74},
        {date: '8/10', desc: 'Mom gave money for crochet', amount: 40.00, balance: 119.73},
        {date: '8/6', desc: 'Babysitting', amount: 25.00, balance: 79.73},
        {date: '7/28', desc: 'Gambling money', amount: -5.00, balance: 54.73},
        {date: '7/28', desc: 'Gambling money', amount: 20.00, balance: 59.73},
        {date: '7/28', desc: 'Work money', amount: 25.00, balance: 39.73},
        {date: '7/24', desc: 'Legos', amount: -9.99, balance: 14.73},
        {date: '7/22', desc: 'Bitcoin', amount: -25.00, balance: 24.72},
        {date: '7/2', desc: 'Shein', amount: -25.81, balance: 49.72},
        {date: '7/13', desc: 'Webtoons', amount: -1.99, balance: 75.53},
        {date: '7/1', desc: 'Gambling money', amount: 18.00, balance: 77.52},
        {date: '7/9', desc: '5 below purchase', amount: -10.76, balance: 59.52},
        {date: '7/7', desc: 'Random vacation Deposit', amount: 18.00, balance: 70.28},
        {date: '6/28', desc: 'Random money found', amount: 5.00, balance: 52.28},
        {date: '6/23', desc: 'Bitcoin fee', amount: -1.69, balance: 47.28},
        {date: '6/23', desc: 'Money as gift', amount: 20.00, balance: 48.97},
        {date: '6/14', desc: 'Item Sold on E-Bay', amount: 13.10, balance: 28.97},
        {date: '6/14', desc: 'Deposit into Savings', amount: -50.00, balance: 15.87},
        {date: '6/14', desc: 'Murder Mystery Game', amount: -23.13, balance: 65.87},
        {date: '6/14', desc: 'Deposit', amount: 89.00, balance: 89.00}
    ];

    function saveState() {
        const state = {
            checkingBalance,
            btcAmount,
            btcPrice,
            transactions
        };
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
            console.warn('Could not save state', e);
        }
    }

    function loadState() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            const state = JSON.parse(raw);

            if (typeof state.checkingBalance === 'number') {
                checkingBalance = state.checkingBalance;
            }
            if (typeof state.btcAmount === 'number') {
                btcAmount = state.btcAmount;
                document.getElementById('btcAmount').value = btcAmount;
            }
            if (typeof state.btcPrice === 'number') {
                btcPrice = state.btcPrice;
                document.getElementById('btcPrice').value = btcPrice.toFixed(2);
            }
            if (Array.isArray(state.transactions) && state.transactions.length) {
                transactions = state.transactions;
            }
        } catch (e) {
            console.warn('Could not load state', e);
        }
    }

    function formatMoney(amount) {
        return '$' + Math.abs(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    function updateDisplay() {
        const btcValue = btcAmount * btcPrice;
        const total = checkingBalance + btcValue;

        document.getElementById('checkingBalance').textContent = formatMoney(checkingBalance);
        document.getElementById('bitcoinBalance').textContent = isNaN(btcValue) ? '$0.00' : formatMoney(btcValue);
        document.getElementById('totalBalance').textContent = isNaN(total) ? '$0.00' : formatMoney(total);
    }

    function updateBitcoinFromInputs() {
        btcAmount = parseFloat(document.getElementById('btcAmount').value) || 0;
        btcPrice  = parseFloat(document.getElementById('btcPrice').value) || 0;
        updateDisplay();
        saveState();
    }

    async function fetchBtcPrice() {
        try {
            const res = await fetch('https://api.coinbase.com/v2/prices/BTC-USD/spot');
            const data = await res.json();
            const price = parseFloat(data.data.amount);
            if (!isNaN(price)) {
                btcPrice = price;
                document.getElementById('btcPrice').value = price.toFixed(2);
                const now = new Date();
                btcMetaText.textContent = 'Live BTC price: ' + formatMoney(price) + ' â€¢ Updated ' + now.toLocaleTimeString();
                updateDisplay();
                saveState();
            }
        } catch (e) {
            btcMetaText.textContent = 'Could not refresh BTC price right now.';
        }
    }

    function showNotification(message) {
        const notif = document.getElementById('notification');
        notif.textContent = message;
        notif.classList.add('show');
        setTimeout(() => {
            notif.classList.remove('show');
        }, 2000);
    }

    function getAmountInput() {
        const raw = document.getElementById('amountInput').value;
        const amount = parseFloat(raw);
        if (isNaN(amount)) return null;
        return amount;
    }

    function addMoney() {
        const amount = getAmountInput();
        const desc = document.getElementById('descInput').value.trim();

        if (amount === null || amount <= 0) {
            showNotification('Please enter a valid amount');
            return;
        }
        if (!desc) {
            showNotification('Please enter a description');
            return;
        }

        checkingBalance += amount;

        const today = new Date();
        const dateStr = (today.getMonth() + 1) + '/' + today.getDate();

        transactions.unshift({
            date: dateStr,
            desc: desc,
            amount: amount, // positive
            balance: checkingBalance
        });

        updateDisplay();
        renderHistory();
        saveState();

        document.getElementById('amountInput').value = '';
        document.getElementById('descInput').value = '';

        showNotification('Money added! +' + formatMoney(amount));
    }

    function spendMoney() {
        const amount = getAmountInput();
        const desc = document.getElementById('descInput').value.trim();

        if (amount === null || amount <= 0) {
            showNotification('Please enter a valid amount');
            return;
        }
        if (!desc) {
            showNotification('Please enter a description');
            return;
        }

        if (amount > checkingBalance) {
            showNotification('Not enough money in checking!');
            return;
        }

        checkingBalance -= amount;

        const today = new Date();
        const dateStr = (today.getMonth() + 1) + '/' + today.getDate();

        transactions.unshift({
            date: dateStr,
            desc: desc,
            amount: -amount, // negative
            balance: checkingBalance
        });

        updateDisplay();
        renderHistory();
        saveState();

        document.getElementById('amountInput').value = '';
        document.getElementById('descInput').value = '';

        showNotification('Purchase recorded! -' + formatMoney(amount));
    }

    function renderHistory() {
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = '';

        transactions.forEach(t => {
            const item = document.createElement('div');
            item.className = 'history-item';

            const isPositive = t.amount > 0;
            const sign = isPositive ? '+' : '-';
            const amountClass = isPositive ? 'positive' : 'negative';

            item.innerHTML = `
                <div class="history-left">
                    <div class="history-date">${t.date}</div>
                    <div class="history-desc">${t.desc}</div>
                </div>
                <div class="history-right">
                    <div class="history-amount ${amountClass}">${sign}${formatMoney(t.amount)}</div>
                    <div class="history-balance">Bal: ${formatMoney(t.balance)}</div>
                </div>
            `;

            historyList.appendChild(item);
        });
    }

    // Initialize
    loadState();
    renderHistory();
    updateDisplay();
    fetchBtcPrice();
    setInterval(fetchBtcPrice, 30000);
</script>
